//var path ='http://m.beta.yjyapp.com/',
var path ='http://'+document.domain+'/',
    islogin = false ,//是否登录
    isreceive = false,//是否已领奖品
    destiUrl  = '',
    timer;
(function () {
    var pull_new = window.pull_new = {
        //description：页面字体rem初始化
        init_size:function () {
            //初始化html字体大小
            var rem_ReSize = function(){
                var w = $(window).width();
                if (w > 640) {
                    w = 640;
                };
                //html元素字体大小 = document根节点(html)宽度 * 100 / 设计图宽度
                $('html').css('font-size', 100 / 640 * w + 'px');
            };
            rem_ReSize();
            //当窗体大小变化时，html字体大小随着变化
            window.onresize = function(){
                rem_ReSize();
            };
            window.onload = function () {
                rem_ReSize();
            };
        },
        //description：活动规则
        rule_toggle:function(tabname,tabcon){
           var $rule_tog = $(".rule-toggle"),//规则查看关闭按钮
               $rule_box = $(".rulebox-dia"),//规则弹窗
               $shade = $(".shade"),//遮罩
               $tab = $(tabname),//规则tab
               $tab_con = $(tabcon);//规则tab内容
           $rule_tog.on("click",function(){
               $rule_box.toggle();
               $shade.toggle();
           });

           $tab.each(function(i){
               $(this).on("click",function(){
                   var $self = $(this);
                   $self.addClass('active').siblings().removeClass('active');
                   $tab_con.eq(i).show().siblings(tabcon).hide();
               });
           });
        },
        //description：分享页 slide 助攻走马灯
        zmd_fun:function(target,height){
            var num = 0;
            clearInterval(timer);
            var goLeft=function() {
                //height是根据你给的尺寸，可变的
                if (num == -height) {
                    num = 0;
                }
                num -= 1;
                $(target).css({top: num})
            }
            if($(target).find("li").length>6){
                timer = setInterval(goLeft, 20);
            }
        },
        //description：移动终端浏览器版本信息
        browser: function(){
            var version= function(){
                var u = navigator.userAgent,
                    app = navigator.appVersion;
                return {
                    mobile: !!u.match(/AppleWebKit.*Mobile.*/), //是否为移动终端
                    ios: !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/), //ios终端
                    android: u.indexOf('Android') > -1 || u.indexOf('Linux') > -1 //android终端或uc浏览器
                };
            };
            return version();
        },
        //description：捕获url参数
        get_QueryString: function (name){
             var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
             var r = window.location.search.substr(1).match(reg);
             if(r!=null)return  unescape(r[2]); return null;
        },
        //description：版本判断
        is_update:function(version){
            var self = this;
            if(version < '110' && version != null){
                $(".version-dia,.shade,.cover").show();
                $("#upd_version").on("click",function(){
                    $(".version-dia,.shade").hide();
                });
                $(".cover").on("click",function(){
                    $(".version-dia,.shade").show();
                });
            }
        },
        //description：跳到登录页
        to_login:function(){
            var self = this;
            if (self.browser().android) {
                window.android.toLogin();
            } else if(self.browser().ios) {
                window.webkit.messageHandlers.toLogin.postMessage('');
            }
        },
        //description：判断是否登录
        is_login:function(){
            var self = this,
                token = '';
            if (self.browser().android) {
                token = window.android.getUserToken();
                islogin = token;
                token == ''? islogin = false : self.check_token(token);
            } else if(self.browser().ios) {
                window.webkit.messageHandlers.getUserToken.postMessage('');//无返回值
            }
        },
        //description：token登录验证
        check_token:function(token){
            var self = this;
            if(token=='') alert('TOKEN已过期,请先登录');
            var data_ajax = {
                'url': path +'huodong/receive/check-token',
                'type': 'GET',
                'dataType': 'jsonp',
                'data': {
                    'token': token
                },
                success: function(d){
                    if(d.status == 1){
                        islogin = token;
                        //初始化判断奖品是否已领取
                        self.is_receive(token);
                        //日志写入
                        self.writeLog("click_num",token);
                    }else if(d.status == -2){
                        self.to_login();
                    }else{
                        alert(d.msg);
                    }
                },
                error: function(d){
                    alert("request error!");
                }
            };
            $.ajax(data_ajax);
        },
        //description：判断奖品是否已领取
        is_receive:function(token){
            var self = this;
            islogin = token;
            var data_ajax = {
                'url':  path +'huodong/receive/is-receive',
                'type': 'GET',
                'dataType': 'jsonp',
                'data': {
                    'token': token
                },
                success: function(d){
                    islogin = token;
                    if(d.status == -4){
                        $("#get_prize").text("奖品已领光").removeClass("scale");
                        isreceive = true;
                    }else if(d.status == -16){
                        $("#get_prize").text("奖品已领取").removeClass("scale");
                        isreceive = true;
                    }else if(d.status == -17){
                        $("#get_prize").text("助攻人数已满").addClass("completed");
                    }
                    return false;
                },
                error: function(d){
                    alert("request error!");
                }
            };
            token=='' ? alert('TOKEN已过期,请先登录') : $.ajax(data_ajax);
        },
        //description：获取邀请链接
        get_receiveUrl:function(token){
            if(token=='') alert('TOKEN已过期,请先登录');
            //生成链接
            $.ajax({
                'url':  path + 'huodong/receive/getdraw',
                'type': 'GET',
                'dataType': 'jsonp',
                'data': {
                    'token': token
                },
                success: function(date){
                    if(date.status == 1){
                        //未邀请
                        $('.invitel-dia,.shade').show();
                        destiUrl = path + 'huodong/receive/assists?id=' + date.id ;
                    }else if(date.status == -8){
                        //邀请不足
                        $('.invite-dia,.shade').show();
                        destiUrl = path + 'huodong/receive/assists?id=' + date.id ;
                    }else if(date.status == -17){
                        //满足邀请条件，未领取奖品
                        $('.jiren-dia,.shade').show();
                    }else if(date.status == 2){
                        //满足邀请条件，已领取奖品
                        $("#get_prize").text("奖品已领取").removeClass("scale");
                    }else if(date.status == -4){
                        //奖品已领光
                        $("#get_prize").text("奖品已领光").removeClass("scale");
                    }else if(date.status == -6){
                        //活动已结束
                        $('.gameover-dia,.shade').show();
                    }else if(date.status == -2){
                        //token过期
                        self.to_login();
                    }else{
                        alert(date.msg);
                    }
                },
                error: function(){
                    alert("request error!");
                }
            });
        },
        //description：邀请微信分享
        invite_share:function(type,title){
            var self = this;
            var content = '考验友谊的时刻来了！速点！帮我变美！',//分享标题
                iconUrl = 'https://static.yjyapp.com/static/h5/receive/images/share.jpg';//分享图片链接
            if (self.browser().android) {
                window.android.shareImage(type,title,content,iconUrl,destiUrl);
                $('.invite-dia,.invitel-dia,.shade').hide();
            } else if (self.browser().ios) {
                var data = {
                    'type': type,
                    'title': title,
                    'content': content,
                    'iconUrl': iconUrl,
                    'destiUrl': destiUrl
                }
                window.webkit.messageHandlers.shareImage.postMessage(data);
                $('.invite-dia,.invitel-dia,.shade').hide();
            }
        },
        //description：领奖信息表单验证
        validate:function(){
            var name    = $('#user_name').val(),
                mobile  = $('#user_phone').val(),
                address = $('#user_address').val(),
                token = islogin,
                //验证手机号格式
                regu =/^((\+?86)|(\(\+86\)))?(((1[3,5,8,4,7][0-9]))\d{8})$/;
            if(name == '' || mobile == '' || address == ''){
                alert("请将信息填写完整！");
                return false;
            }else if(!regu.test(mobile)){
                alert("手机格式有误！");
                return false;
            }
            var data_ajax = {
                'url': path +'huodong/receive/add-address',
                'type': 'GET',
                'dataType': 'jsonp',
                'data': {
                    'token': token,
                    'username': name,
                    'mobile': mobile,
                    'address': address
                },
                success: function(d){
                    if(d.status == 1){
                        $(".writeinfo-dia").hide();
                        $(".getinfosud-dia,.shade").show();//提交成功弹窗
                        $(".get-btn").removeClass("scale").text("已领取");
                    }else{
                        alert(d.msg);
                    }
                },
                error: function(){
                    alert("request error!");
                }
            };
            $.ajax(data_ajax);
        },
        //description：分享页点击助攻
        give_help:function(){
            var self = this,
                $target = $("#give-help"),
                per = $("#zg-percent").attr("data-percent");
                per =parseInt(per);
            var gif_fun = function(per){
                $(".gif-progress").css("height",(100-per)+"%");
                $(".gif-progress").attr("src","http://static.yjyapp.com/static/h5/receive/images/gifp.gif");
            };
            gif_fun(per);//初始化助攻百分比

            var userid = self.get_QueryString('id');//获取用户id
            $target.on("click",function(){
                if(per < 100 ){
                    var data_ajax = {
                        'url': path +'huodong/receive/add-assists',
                        'type': 'GET',
                        'dataType': 'jsonp',
                        'data': {
                            'id': userid
                        },
                        success: function(d){
                            if(d.status == 1){
                                per = per + Math.floor(Math.random()*4+1);
                                per>100 ? per=100 : per=per;
                                gif_fun(per);
                                $("#zg-percent").attr("data-percent",per);
                                $(".percent .d-per").text(per+"%");
                                $(".get-btn").removeClass("scale").text("已助攻");
                                //数据显示
                                $(".zg-h2,.ulbox ul").show();
                                $(".ulbox .empty").hide();
                                //助攻+1，插入数据
                                var zgnum = $("#zg-num").text();
                                $("#zg-num").text(parseInt(zgnum)+1);
                                var _zgli="<li><img src='"+ userInfo.img +"' alt=''><span class='ell'>"+ userInfo.username +"&#12288;已助攻啦~</span></li>";
                                $("#zg-list ul").prepend(_zgli);
                                ///////////插入数据时重新计算高度
                                var hzmd=$(".scroll-box .ulbox").height();
                                self.zmd_fun(".scroll-box .ulbox",parseInt(hzmd/2));

                                setTimeout(function(){
                                    $(".zlsuc-dia,.shade").fadeIn();
                                },1200);
                            }else{
                                alert(d.msg);
                            }
                        },
                        error:function(){
                            alert("request error!");
                        }
                    };
                    $.ajax(data_ajax);
                }
            });
        },
        //description：统计数据
        writeLog:function(type,token) {
            var data_ajax = {
                'url':  path +'huodong/receive/write-log',
                'type': 'GET',
                'dataType': 'jsonp',
                'data': {
                    'type': type,
                    'token':token
                },
                success: function(res){
                },
                error: function(){
                    alert("request error!");
                }
            };
            $.ajax(data_ajax);
            return false;
        },
        //description：重置alert
        reset_alert:function(){
            window.alert = function(name){
                var iframe = document.createElement("IFRAME");
                iframe.style.display="none";
                iframe.setAttribute("src", 'data:text/plain,');
                document.documentElement.appendChild(iframe);
                window.frames[0].window.alert(name);
                iframe.parentNode.removeChild(iframe);
            }
        },
        ////////////////////////////////////////////////////////////////
        ////////////////////  首页初始化 事件绑定  //////////////////////
        index_init:function(){
            var self = this;
            //初始化字体
            self.init_size();
            //重置alert
            self.reset_alert();
            //顶部活动规则
            self.rule_toggle(".rulebox-dia .tab span",".tab-con");
            //关闭分享弹窗
            $(".dia-close").on("click",function(){
                $(".invite-dia,.invitel-dia,.getinfosud-dia,.shade").hide();
            });
            //领奖信息弹窗显示
            $('.jiren-dia .btn').on("click",function(){
                $(".jiren-dia").hide();
                $(".writeinfo-dia,.shade").show();
            });

            //判断版本更新
            self.is_update(self.get_QueryString('version'));
            //点击免费领取,交互流程
            $("#get_prize").on("click",function(){
                if(!isreceive){
                    self.is_login();
                    setTimeout(function(){
                        var token = islogin;
                        if(token==''){
                            self.to_login();
                        }else{
                            self.get_receiveUrl(token);
                        }
                    },100);
                }
            });
            //领奖信息验证
            $("#info-submit").on("click",function(){
                self.validate();
            });
            //微信好友分享
            $("#share_hy_1,#share_hy_2").on("click",function(){
                self.invite_share(0, '你的好友向你发来一份礼品！');
            });
            //微信朋友圈分享
            $("#share_pyq_1,#share_pyq_2").on("click",function(){
                self.invite_share(1, '你的好友向你发来一份礼品！');
            });
        },
        ////////////////////////////////////////////////////////////////
        ////////////////////  分享页初始化 事件绑定  ////////////////////
        share_init:function(){
            var self = this;
            //初始化字体
            self.init_size();
            //重置alert
            self.reset_alert();
            //底部活动规则
            self.rule_toggle(".s-rule-tab span",".opacity-box .text-box");
            //助攻走马灯
            var hzmd=$(".scroll-box .ulbox").height();
            self.zmd_fun(".scroll-box .ulbox",parseInt(hzmd/2));
            //点击助攻进度情况
            self.give_help();
            //日志写入
            //self.writeLog("click_num",'');
        }
    }
})();

//description：接收ios返回token参数值
function getiOSUserToken(token) {
    token == ''? islogin=false : pull_new.check_token(token);//验证token
    islogin = token;
}
