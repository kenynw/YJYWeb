var path ='http://'+document.domain+'/',
//var path ='http://m.beta.yjyapp.com/',
    islogin = false ,//是否登录
    isreceive = false,//是否已领奖品
    destiUrl  = '',
    timer,
    shareUser = '';
(function () {
    'use strict';
    var pull_new = window.pull_new = {
        //description：页面字体rem初始化
        initSize:function () {
            //初始化html字体大小
            var rem_ReSize = function(){
                var w = $(window).width();
                if (w > 640) {
                    w = 640;
                };
                //html元素字体大小 = document根节点(html)宽度 * 100 / 设计图宽度
                $('html').css('font-size', 100 / 640 * w + 'px');
            };
            rem_ReSize();
            //当窗体大小变化时，html字体大小随着变化
            window.onresize = function(){
                rem_ReSize();
            };
            window.onload = function () {
                rem_ReSize();
            };
            //首页一屏显示
            var body_h = $("body").height(),
                win_h =$(window).height();
            if( body_h <  win_h){
                $(".index-page").height(win_h-8);
            }
        },
        //description：活动规则
        ruleToggle:function(tabname,tabcon){
           var $rule_tog = $(".rule-toggle"),//规则查看关闭按钮
               $rule_box = $(".rulebox-dia"),//规则弹窗
               $tab = $(tabname),//规则tab
               $tab_con = $(tabcon);//规则tab内容
            $rule_box.height($("body").height());
            $rule_tog.on("click",function(){
               $rule_box.toggle();
            });

            $tab.each(function(i){
               $(this).on("click",function(){
                   var $self = $(this);
                   $self.addClass('active').siblings().removeClass('active');
                   $tab_con.eq(i).show().siblings(tabcon).hide();
                   $(".active-line").attr("class","active-line pos"+parseInt($self.index()+1));
               });
            });

            //关闭弹窗
            $(".dia-close").on("click",function(){
                $(".dialog,.invitel-dia,.getinfosud-dia,.shade").hide();
            });
        },
        //description：分享页 slide 助攻走马灯
        zmdFun:function(target,height){
            var num = 0;
            clearInterval(timer);
            var goLeft=function() {
                //height是根据你给的尺寸，可变的
                if (num == -height) {
                    num = 0;
                }
                num -= 1;
                $(target).css({top: num})
            }
            if($(target).find("li").length>6){
                timer = setInterval(goLeft, 20);
            }
        },
        //description：移动终端浏览器版本信息
        browser: function(){
            var version= function(){
                var u = navigator.userAgent,
                    app = navigator.appVersion;
                return {
                    mobile: !!u.match(/AppleWebKit.*Mobile.*/), //是否为移动终端
                    ios: !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/), //ios终端
                    android: u.indexOf('Android') > -1 //android终端
                };
            };
            return version();
        },
        //description：捕获url参数
        getQueryString: function (name){
             var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
             var r = window.location.search.substr(1).match(reg);
             if(r!=null)return  unescape(r[2]); return null;
        },
        //description：版本判断
        isUpdate:function(version){
            var self = this;
            var version = parseInt(version);
            if(version < '110' && version != null){
                $(".version-dia,.shade,.cover").show();
                $("#upd_version").on("click",function(){
                    $(".version-dia,.shade").hide();
                });
                $(".cover").on("click",function(){
                    $(".version-dia,.shade").show();
                });
            }
        },
        //description：跳到登录页
        to_login:function(){
            var self = this;
            if (self.browser().android) {
                window.android.toLogin();
            } else if(self.browser().ios) {
                window.webkit.messageHandlers.toLogin.postMessage('');
            }
        },
        //description：判断是否登录
        isLogin:function(){
            var self = this,
                token = '';
            if (self.browser().android) {
                token = window.android.getUserToken();
                islogin = token;
                token == ''? islogin = false : self.checkToken(token);
            } else if(self.browser().ios) {
                window.webkit.messageHandlers.getUserToken.postMessage('');//无返回值
            }
        },
        //description：token登录验证
        checkToken:function(token){
            var self = this;
            if(token=='') alert('TOKEN已过期,请先登录');
            var data_ajax = {
                'url': path +'huodong/biore/check-token',
                'type': 'GET',
                'dataType': 'jsonp',
                'data': {
                    'token': token
                },
                success: function(d){
                    if(d.status == 1){
                        islogin = token;
                        //初始化判断奖品是否已领取
                        self.isReceive(token);
                        //日志写入
                        self.writeLog("click_num",token);
                    }else if(d.status == -2){
                        self.to_login();
                    }else{
                        alert(d.msg);
                    }
                },
                error: function(d){
                    alert("request error!");
                }
            };
            $.ajax(data_ajax);
        },
        //description：判断奖品是否已领取
        isReceive:function(token){
            var self = this;
            islogin = token;
            var data_ajax = {
                'url':  path +'huodong/biore/is-receive',
                'type': 'GET',
                'dataType': 'jsonp',
                'data': {
                    'token': token
                },
                success: function(d){
                    if(d.status == 1){
                       islogin = token;
                       shareUser = d.username;
                    }else if(d.status == -4){
                        $("#get_prize").text("奖品已领光").removeClass("scale");
                        isreceive = true;
                    }else if(d.status == -16){
                        $("#get_prize").text("奖品已领取").removeClass("scale");
                        isreceive = true;
                    }else if(d.status == -17){
                        $("#get_prize").text("助攻完成，领取奖品");
                    }else if(d.status == -6){
                        //活动已结束
                        $('.gameover-dia,.shade').show();
                    }else{
                        alert(d.msg);
                    }
                    return false;
                },
                error: function(d){
                    alert("request error!");
                }
            };
            token=='' ? alert('TOKEN已过期,请先登录') : $.ajax(data_ajax);
        },
        //description：获取邀请链接
        getReceiveUrl:function(token){
            if(token=='') alert('TOKEN已过期,请先登录');
            //生成链接
            $.ajax({
                'url':  path + 'huodong/biore/getdraw',
                'type': 'GET',
                'dataType': 'jsonp',
                // 'data': {
                //     'token': token
                // },
                success: function(d){
                    if(d.status == 1){
                        //未邀请
                        $('.invitel-dia,.shade').show();
                        destiUrl = path + 'huodong/biore/assists?id=' + d.id ;
                    }else if(d.status == -8){
                        //邀请不足
                        $('.invite-dia,.shade').show();
                        destiUrl = path + 'huodong/biore/assists?id=' + d.id ;
                    }else if(d.status == -17){
                        //满足邀请条件，未领取奖品
                        $("#get_prize").text("助攻完成，领取奖品");
                        $('.jiren-dia,.shade').show();
                    }else if(d.status == 2){
                        //满足邀请条件，已领取奖品
                        $("#get_prize").text("奖品已领取").removeClass("scale");
                    }else if(d.status == -4){
                        //奖品已领光
                        $("#get_prize").text("奖品已领光").removeClass("scale");
                    }else if(d.status == -6){
                        //活动已结束
                        $('.gameover-dia,.shade').show();
                    }else if(d.status == -2){
                        //token过期
                        self.to_login();
                    }else{
                        alert(d.msg);
                    }
                },
                error: function(){
                    alert("request error!");
                }
            });
        },
        //description：邀请微信分享
        inviteShare:function(type,title){
            var self = this;
            var content = '考验友谊的时刻来了！速点！帮我变美！',//分享标题
                iconUrl = 'https://static.yjyapp.com/static/h5/huodong/biore/images/share.jpg';//分享图片链接
            if (self.browser().android) {
                window.android.shareImage(type,title,content,iconUrl,destiUrl);
                $('.invite-dia,.invitel-dia,.shade').hide();
            } else if (self.browser().ios) {
                var data = {
                    'type': type,
                    'title': title,
                    'content': content,
                    'iconUrl': iconUrl,
                    'destiUrl': destiUrl
                }
                window.webkit.messageHandlers.shareImage.postMessage(data);
                $('.invite-dia,.invitel-dia,.shade').hide();
            }
        },
        //description：领奖信息表单验证
        validate:function(){
            var name    = $('#user_name').val(),
                mobile  = $('#user_phone').val(),
                address = $('#user_address').val(),
                token = islogin,
                //验证手机号格式
                regu =/^((\+?86)|(\(\+86\)))?(((1[3,5,8,4,7][0-9]))\d{8})$/;
            if(name == '' || mobile == '' || address == ''){
                alert("请将信息填写完整！");
                return false;
            }else if(!regu.test(mobile)){
                alert("手机格式有误！");
                return false;
            }
            var data_ajax = {
                'url': path +'huodong/biore/add-address',
                'type': 'GET',
                'dataType': 'jsonp',
                'data': {
                    //'token': token,
                    'username': name,
                    'mobile': mobile,
                    'address': address
                },
                success: function(d){
                    if(d.status == 1){
                        $(".writeinfo-dia").hide();
                        $(".getinfosud-dia,.shade").show();//提交成功弹窗
                        $(".get-btn").removeClass("scale").text("已领取");
                        isreceive = true;
                    }else{
                        alert(d.msg);
                    }
                },
                error: function(){
                    alert("request error!");
                }
            };
            $.ajax(data_ajax);
        },
        //description：分享页点击助攻
        giveHelp:function(){
            var self = this,
                $target = $("#give-help"),
                per = $("#zg-percent").attr("data-percent");
                per =parseInt(per);
            var gif_fun = function(per){
                $(".gif-progress").css("height",(100-per)+"%");
                $(".gif-progress").attr("src","http://static.yjyapp.com/static/h5/huodong/biore/images/gifp.gif");
            };
            gif_fun(per);//初始化助攻百分比

            var userid = self.getQueryString('id');//获取用户id
            $target.on("click",function(){
                if(per < 100 ){
                    var data_ajax = {
                        'url': path +'huodong/biore/add-assists',
                        'type': 'GET',
                        'dataType': 'jsonp',
                        'data': {
                            'id': userid
                        },
                        success: function(d){
                            if(d.status == 1){
                                //助攻水波百分比
                                per = per + Math.floor(Math.random()*4+1);
                                per>100 ? per=100 : per=per;
                                gif_fun(per);
                                $("#zg-percent").attr("data-percent",per);
                                $(".percent .d-per").text(per+"%");
                                $(".get-btn").addClass("completed").text("已助攻");
                                //助攻列表数据显示
                                $(".zg-h2,.ulbox .marquee-box").show();
                                $(".ulbox .empty").hide();
                                //助攻+1，插入数据
                                var zgnum = $("#zg-num").text();
                                $("#zg-num").text(parseInt(zgnum)+1);
                                var _zgli="<span class='list'><img src='"+ userInfo.img +"' alt=''><span class='ell'>"+ userInfo.username +"</span>已助攻啦~</span>";
                                $(".marquee-box").prepend(_zgli);

                                $(".zlsuc-dia h2").html("哇耶！助力成功啦！<br>没有你我可怎么办...");
                                $(".zlsuc-dia,.shade").fadeIn();
                            }else if(d.status == -18){
                                $(".zlsuc-dia h2").html("助攻人数已满！<br>进入app，你也可以免费领奖哦");
                                $(".zlsuc-dia,.shade").fadeIn();
                            }else if(d.status == -14){
                                $(".zlsuc-dia h2").html("只能帮2个好友助攻哦！<br>进入app，你也可以免费领奖哦");
                                $(".zlsuc-dia,.shade").fadeIn();
                            }else if(d.status == -6){
                                $('.gameover-dia,.shade').show();
                            }else{
                                alert(d.msg);
                            }
                        },
                        error:function(){
                            alert("request error!");
                        }
                    };
                    $.ajax(data_ajax);
                }
            });
        },
        //description：统计数据
        writeLog:function(type,token) {
            var data_ajax = {
                'url':  path +'huodong/biore/write-log',
                'type': 'GET',
                'dataType': 'jsonp',
                'data': {
                    //'token':token,
                    'type': type
                },
                success: function(res){
                },
                error: function(){
                    alert("request error!");
                }
            };
            $.ajax(data_ajax);
            return false;
        },
        //description：重置alert
        resetAlert:function(){
            window.alert = function(name){
                var iframe = document.createElement("IFRAME");
                iframe.style.display="none";
                iframe.setAttribute("src", 'data:text/plain,');
                document.documentElement.appendChild(iframe);
                window.frames[0].window.alert(name);
                iframe.parentNode.removeChild(iframe);
            }
        },
        //description：唤醒app功能
        openAPP:function(){
            var url   = 'https://api.yjyapp.com/asa/download?type=3&id=1&hid=3';
            var toUrl = 'http://m.yjyapp.com/huodong/biore/';
            if (this.browser().ios) {
                $(".openapp-btn").attr("href",url+ '&unltype=0&unlrelation=' + toUrl);
            }else if (this.browser().android) {
               window.location = url+ '&unltype=0&unlrelation=' + toUrl;
            }
        },
        //description：公众号复制功能
        copyGzh:function(){
            var yhjid =0;
            $(".copy-btn").html("<span id='copybtn'  class='copybtn'>点我复制</span><div class='share-content' id='"+yhjid+"' style='display:none;position:fixed;top:-1000px'></div>").show();
            $("#copybtn").on("click",function(){
                var a=$(".wxh-txt").attr("data-taowords");
                a=a.replace(/<br>/ig,"");console.log(a);
                $(".share-content").html(a);
                $(".share-content").show();
                $("#ckcopy").hide()
            });
            $("#copybtn").show();
            var clipboard=new Clipboard("#copybtn",{text:function(){
                return $(".share-content").html()
            }});
            clipboard.on("success",function(a){
                a.trigger.innerHTML="复制成功";
                a.trigger.style.backgroundColor="#54c3bd";
                a.trigger.style.borderColor="#54c3bd";
                a.trigger.style.color="#fff";
                $(".share-content").hide();
                console.info("Action:",a.action);
                console.info("Text:",a.text);
                console.info("Trigger:",a.trigger);
                a.clearSelection()
            });
            clipboard.on("error",function(a){
                a.trigger.innerHTML="复制失败";
                setTimeout(function(){
                    a.trigger.innerHTML="硬件不支持"
                },1000);
                a.trigger.style.backgroundColor="#bbb";
                a.trigger.style.borderColor="#bbb";
                a.trigger.style.color="#fff";
                $(".share-content").hide();
                console.info("Action:",a.action);
                console.info("Text:",a.text);
                console.info("Trigger:",a.trigger);
                a.clearSelection()
            });
        },
        ////////////////////////////////////////////////////////////////
        ////////////////////  首页初始化 事件绑定  //////////////////////
        indexInit:function(){
            var self = this;
            //初始化字体
            //self.initSize();
            //重置alert
            self.resetAlert();
            //顶部活动规则
            self.ruleToggle(".rulebox-dia .tab .btn span",".tab-con");
            self.copyGzh();
            //领奖信息弹窗显示
            $('.jiren-dia .btn').on("click",function(){
                $(".jiren-dia").hide();
                $(".writeinfo-dia,.shade").show();
            });
            //判断版本更新
            //self.isUpdate(self.getQueryString('version'));
            //点击免费领取,交互流程
            $("#get_prize").on("click",function(){
                if(!isreceive){
                    self.isLogin();
                    setTimeout(function(){
                        var token = islogin;
                        if(token==''){
                            self.to_login();
                        }else{
                            self.getReceiveUrl(token);
                        }
                    },100);
                }
            });
            //领奖信息验证
            $("#info-submit").on("click",function(){
                self.validate();
            });
            //微信好友分享
            $("#share_hy_1,#share_hy_2").on("click",function(){
                if(shareUser!='' && shareUser!= null){
                    self.inviteShare(0, shareUser+'邀请您帮TA助攻领奖品！');
                }else{
                    self.inviteShare(0, '您的好友邀请您帮TA助攻领奖品！');
                }
            });
            //微信朋友圈分享
            $("#share_pyq_1,#share_pyq_2").on("click",function(){
                if(shareUser!='' && shareUser!= null){
                    self.inviteShare(1, shareUser+'邀请您帮TA助攻领奖品！');
                }else{
                    self.inviteShare(1, '您的好友邀请您帮TA助攻领奖品！');
                }
            });
        },
        ////////////////////////////////////////////////////////////////
        ////////////////////  分享页初始化 事件绑定  ////////////////////
        shareInit:function(){
            var self = this;
            //初始化字体
            self.initSize();
            //重置alert
            self.resetAlert();
            //玩法规则
            self.ruleToggle(".rulebox-dia .tab .btn span",".tab-con");
            //进入自己助攻页，未完成助攻，邀请遮罩
            $(".zz-toggle").on("click",function(){
               $(".invite-firend").toggle();
            });
            //进入自己助攻页，已完成助攻，唤醒app
            $(".openapp-btn").on("click",function(){
                self.openAPP();
            });
            //点击助攻进度情况
            self.giveHelp();
            //日志写入
            //self.writeLog("click_num",'');
        }
    }
})();

//description：接收ios返回token参数值
function getiOSUserToken(token) {
    token == ''? islogin=false : pull_new.checkToken(token);//验证token
    islogin = token;
}
